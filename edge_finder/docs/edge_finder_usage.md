# Edge Finder Usage

This document explains how to run the Edge Finder CLI pipeline.

## Overview

The edge finder pipeline runs end-to-end in a single CLI command:

- OpenAI handles concept generation and concept re-mapping.
- LeanExplore handles semantic search for Mathlib declarations.
- An LLM concept re-mapping step (Iteration 5) grounds generated concept names against actual Mathlib declaration names found in search results, addressing naming convention mismatches.
- The verification layer classifies each (remapped) hypothesized concept against search results in two passes: broad theme-level search (pass 1), then per-concept targeted queries for under-covered concepts (pass 2, skippable with `--skip-targeted-search`).
- The density analyzer and gap heuristics assess structural coverage.
- All artifacts are written to a timestamped run directory.

## Prerequisites

- Python 3.11+.
- A virtual environment with dependencies installed (`edge_finder/venv/`).
- OpenAI API key (set `OPENAI_API_KEY`).
- LeanExplore API key (set `LEANEXPLORE_API_KEY`).

## Environment setup

Create a `.env` file in the repo root (or export environment variables):

```
OPENAI_API_KEY=...
LEANEXPLORE_API_KEY=...
```

The CLI loads `.env` automatically. Variables already set in the environment take precedence.

## Run the pipeline

From the repo root:

```bash
PYTHONPATH=edge_finder edge_finder/venv/bin/python -m edge_finder --theme "finite sums"
```

### CLI options

| Flag | Default | Description |
|---|---|---|
| `--theme` | (required) | Mathematical theme to investigate |
| `--model` | `gpt-4o-mini` | OpenAI model for concept generation and concept re-mapping |
| `--search-limit` | `20` | Max results per LeanExplore query |
| `--output-dir` | `runs/edge_finder` | Base directory for run outputs |
| `--version` | `0.1.0` | Version tag included in run metadata |
| `--dry-run` | off | Skip OpenAI calls; use cached inputs |
| `--concepts-path` | none | Path to cached `concepts.json` (required for `--dry-run`) |
| `--pocket-path` | none | [DEPRECATED] Path to cached `pocket.json` (old Module 4, removed from scope) |
| `--skip-targeted-search` | off | Skip per-concept targeted queries (pass 2 refinement). Useful for faster iteration when only testing pass 1 logic. |
| `--skip-remap` | off | Skip LLM concept re-mapping (Iteration 5 grounding step). Concepts are passed to verification as-is. Useful for testing without the re-mapping LLM call. |

### Dry-run mode

Dry-run mode skips all OpenAI API calls, using cached concept files instead. This is the cheapest way to iterate on the search, verification, and analysis logic.

```bash
PYTHONPATH=edge_finder edge_finder/venv/bin/python -m edge_finder \
  --theme "finite sums" \
  --dry-run \
  --concepts-path edge_finder/edge_finder/sample_concepts.json
```

A `sample_concepts.json` for the "finite sums" theme is included in the package.

## Output artifacts

Each run creates a directory: `runs/edge_finder/run_<YYYY-MM-DD_HHMMSS>_<theme>/`

| File | Description |
|---|---|
| `concepts.json` | Structured hypothesis from the Concept Generator (primitives, operators, identity families, candidate namespaces, search queries) |
| `concepts_remapped.json` | Concepts with names remapped to Mathlib declarations (Iteration 5). Only present if re-mapping was not skipped. |
| `remap_log.json` | Mapping log with original name, remapped name, and reason for each concept (Iteration 5). Only present if re-mapping was not skipped. |
| `search_log.jsonl` | One JSONL entry per search query with timing and result count |
| `search_responses.json` | Full search results from LeanExplore |
| `verification.json` | Per-concept verification report (status, match evidence, summary statistics) |
| `pocket.json` | [DEPRECATED] Old Module 4 output. Still generated by the code but removed from the Edge Finder's scope. Replaced by `candidates.json`. |
| `candidates.json` | Pocket candidate ranking output: clustered and scored absent/partial concepts with justification, feasibility notes, and risk assessment. See `candidate_ranker/edge_finder_pocket_candidates.md`. |
| `run_<date>_<theme>.json` | Combined run report with all artifacts and metadata |

### verification.json format

```json
{
  "summary": {
    "total": 12,
    "verified": 11,
    "partial": 1,
    "absent": 0,
    "name_mismatch": 0,
    "coverage_ratio": 1.0
  },
  "entries": [
    {
      "concept": "Finset",
      "kind": "primitive",
      "status": "verified",
      "matches": [
        {
          "result_name": "Finset",
          "result_module": "Mathlib.Data.Finset.Basic",
          "match_type": "exact",
          "detail": "Exact name match: Finset"
        }
      ],
      "searched_queries": ["finite sum", "Finset sum", ...]
    },
    ...
  ]
}
```

The summary reflects the final state after both verification passes. With `--skip-targeted-search`, expect lower coverage (e.g., 0.667 for the "finite sums" test theme vs. 1.0 with targeted search).

**Verification statuses:**

- `verified` — Exact or qualified-suffix name match found (e.g., `Finset.sum` matches concept `sum`).
- `partial` — Concept appears as substring in a result name, but no exact match.
- `absent` — No results match by any criterion.
- `name_mismatch` — Concept appears in a result's informalization/docstring but not in its name.

### remap_log.json format

Present only when concept re-mapping runs (not skipped via `--skip-remap` or `--dry-run`).

```json
[
  {
    "original": "ker",
    "remapped": "GroupHom.ker",
    "reason": "Matched to GroupHom.ker in Mathlib"
  },
  {
    "original": "MonoidHom.comp",
    "remapped": "MonoidHom.comp",
    "reason": "Already matches Mathlib declaration"
  },
  {
    "original": "first_isomorphism_theorem",
    "remapped": null,
    "reason": "No matching declaration found in search results"
  }
]
```

Null entries mean the LLM determined no matching Mathlib declaration exists in the search results. The pipeline falls back to the original name for these (so targeted search can still attempt to find them).

### Gap categories

The gap classifier (in the run report JSON under `gap_report.findings`) uses verification coverage as its sole gap signal. Density metrics are reported as informational context but do not produce gap claims.

| Category | Meaning | Confidence levels |
|---|---|---|
| `concept_coverage_gap` | Verification shows significant absent/partial concepts. This is the sole gap signal. | `high` (coverage < 0.3), `moderate` (< 0.5), `low` (< 0.7). Downgraded one tier if search coverage < 0.7 (API failures). |
| `density_context` | Informational summary of density metrics (declarations, namespaces, modules, spread ratio, operator hits). Not a gap claim. | `informational` (always) |
| `well_covered` | Verification coverage >= 0.7. Positive confirmation the theme is well-represented. No gaps detected. | `moderate` |
| `insufficient_signal` | No declarations found or no verification data provided. Gap detection could not run. | `low` |

**Example gap report (sparse theme, "tropical geometry"):**

```json
{
  "findings": [
    {
      "category": "concept_coverage_gap",
      "confidence": "moderate",
      "evidence": [
        "Coverage ratio: 0.0 (29/29 concepts under-covered)",
        "Absent concepts: TropicalSemiring, TropicalPolynomial, ...",
        "Search coverage: 0.2414 (low - some absences may be false negatives)"
      ]
    },
    {
      "category": "density_context",
      "confidence": "informational",
      "evidence": [
        "1500 declarations across 212 modules",
        "354 unique namespaces (2-level)",
        "Module spread ratio: 0.141",
        "Operator hit ratio: 0.005 (7 operators detected)",
        "Search query coverage: 0.2414"
      ]
    }
  ]
}
```

**Example gap report (well-covered theme, "finite sums" with targeted search):**

```json
{
  "findings": [
    {
      "category": "well_covered",
      "confidence": "moderate",
      "evidence": [
        "Coverage ratio: 1.0 (11 verified, 1 partial out of 12 concepts)"
      ]
    },
    {
      "category": "density_context",
      "confidence": "informational",
      "evidence": [
        "1500 declarations across 259 modules",
        "546 unique namespaces (2-level)",
        "Module spread ratio: 0.173",
        "Operator hit ratio: 0.0143 (15 operators detected)"
      ]
    }
  ]
}
```

## Notes

- The pipeline prints only the output path to stdout. All other output is in the run directory.
- LeanExplore local backend support can be added later for offline use.
- Lean LSP integration is deferred to Phase B.
- See `edge_finder_architecture.md` for design details and iteration plan.
- See `edge_finder_walkthrough.md` for codebase walkthrough and maintenance guide.
